<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Meta first -->
  <meta charset="utf-8" />
  <title>VoIP Shop — Shopping Cart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17526288798"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'AW-17526288798');
  </script>

  <!-- reCAPTCHA v3 (non-blocking) -->
  <script async defer src="https://www.google.com/recaptcha/api.js?render=6LcI2rUrAAAAADaW9lGy3WZfBS-KzmnhWpOlcSVw"></script>

  <!-- Diagnostic helper (optional) -->
  <script>
    window.__rcDiag = async function(action='send_quote'){
      try {
        console.log('[rc] grecaptcha type:', typeof grecaptcha);
        const ready = new Promise((resolve)=>grecaptcha.ready(resolve));
        const timeout = new Promise((_,rej)=>setTimeout(()=>rej(new Error('ready_timeout')),8000));
        await Promise.race([ready, timeout]);
        const t = await grecaptcha.execute('6LcI2rUrAAAAADaW9lGy3WZfBS-KzmnhWpOlcSVw', {action});
        console.log('[rc] token len:', t.length, 'sample:', t.slice(0,25)+'…');
        return t;
      } catch (e) {
        console.error('[rc] failure:', e);
        throw e;
      }
    };
  </script>

  <!-- Performance hints -->
  <meta http-equiv="x-dns-prefetch-control" content="on" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>

  <style>
    /* --- Critical layout (no Tailwind required) --- */
    .cart-grid{
      max-width:1280px; /* ≈ max-w-screen-xl */
      margin:0 auto;
      padding:2rem 1.5rem; /* ≈ py-8 px-6 */
      display:grid;
      grid-template-columns:1fr; /* mobile */
      gap:2rem;                /* ≈ gap-8 */
    }
    .cart-left, .cart-right{ grid-column:auto / span 1; }
    @media (min-width:1024px){ /* ≈ lg: */
      .cart-grid{ grid-template-columns:repeat(12, minmax(0,1fr)); }
      .cart-left { grid-column:span 8; }  /* ≈ lg:col-span-8 */
      .cart-right{ grid-column:span 4; }  /* ≈ lg:col-span-4 */
    }

    /* =========================
       Base + Performance
       ========================= */
    :root{
      --ink:#111;
      --muted:#4b5563;
      --bg:#f5f5f7;
      --border:#e5e7eb;
      --blue:#0B63E6;
      --blue-50:#EFF5FF;
      --teal:#0E5B52;
      --teal-50:#E8F4F2;
      --shadow:0 6px 18px rgba(0,0,0,.06);
    }
    html, body{
      font-family:-apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
      background:var(--bg); color:var(--ink);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* (micro-polish)
       ❌ Removed global content-visibility:auto from main/aside/section.
       We'll explicitly opt-in only where beneficial (none on this page). */

    .tabular-nums{ font-variant-numeric:tabular-nums; }

    /* =========================
       Table-like rows (responsive grid)
       ========================= */
    .table-head{ background:#fff; }
    .table-row{
      background:#fff; border-radius:14px; border:1px solid var(--border);
      display:grid; gap:12px; padding:12px;
    }
    /* Mobile-first: 2 cols — name full row; qty left; total right */
    @media (max-width: 767.98px){
      .table-row{ grid-template-columns: 1fr auto; align-items:center; }
      .table-row [data-cell="name"]  { grid-column:1/-1; }
      .table-row [data-cell="qty"]   { grid-column:1/2; justify-self:start; }
      .table-row [data-cell="total"] { grid-column:2/3; justify-self:end; text-align:right; }
    }
    /* Tablet+Desktop: 12-col grid — name(1-8), qty(9-10), total(11-12) */
    @media (min-width:768px){
      .table-row{ grid-template-columns:repeat(12,minmax(0,1fr)); align-items:center; }
      .table-row [data-cell="name"]  { grid-column:1 / span 8; }
      .table-row [data-cell="qty"]   { grid-column:9 / span 2; justify-self:start; }
      .table-row [data-cell="total"] { grid-column:11 / span 2; justify-self:end; text-align:right; }
    }

    /* Qty area */
    .table-row [data-cell="qty"]{ display:flex; justify-content:flex-start; align-items:center; white-space:nowrap; }
    :root { --qty-pill-number-nudge:-14px; }
    .qty-pill{ display:inline-flex; align-items:center; height:28px; border-radius:10px; background:#fff; border:1px solid var(--border); overflow:hidden; transform:translateX(var(--qty-pill-number-nudge)); }
    .qty-pill>*+*{ border-left:1px solid #eaecef; }
    .qty-btn{ width:28px; height:100%; display:grid; place-items:center; background:transparent; border:0; font-weight:700; font-size:14px; line-height:1; color:#0f172a; cursor:pointer; transition:background .12s ease, transform .05s ease; -webkit-tap-highlight-color:transparent; }
    .qty-btn:hover{ background:#f2f4f7; } .qty-btn:active{ transform:scale(.98); } .qty-btn:disabled{ opacity:.4; pointer-events:none; }
    .qty-value{ min-width:28px; text-align:center; font-variant-numeric:tabular-nums; font-weight:600; font-size:13px; line-height:1; }

    .qty-plain{ display:inline-flex; align-items:center; justify-content:center; height:28px; min-width:34px; padding:0 8px; border-radius:10px; border:1px solid var(--border); background:#fff; font-weight:600; font-size:13px; line-height:1; color:#0f172a; }

    .chip{ display:inline-flex; align-items:center; height:20px; padding:0 8px; gap:.3rem; border-radius:9999px; font-size:11px; line-height:1; border:1px solid var(--border); background:#fff; color:#4b5563; box-shadow:none; }
    .chip-primary{ background:#eef4ff; border-color:#e0e7ff; color:#1e40af; }
    .chip-ghost{ background:#f3f4f6; border-color:var(--border); color:#4b5563; }

    .js-subtext{ margin-top:.25rem; }

    /* =========================
       Totals rows (inside table)
       ========================= */
    .table-total{ background:#fff; border:1px solid var(--border); border-radius:14px; }
    .table-total .label{ font-size:.95rem; color:#4b5563; font-weight:600; }
    .table-total .amount{ text-align:right; font-weight:700; color:#111827; }

    @media (max-width:480px){
      :root{ --qty-pill-number-nudge:-12px; }
      .qty-pill{ height:26px; } .qty-btn{ width:26px; font-size:13px; } .qty-value{ min-width:26px; font-size:12px; }
      .qty-plain{ height:26px; min-width:30px; padding:0 6px; font-size:12px; }
      .chip{ height:18px; font-size:10.5px; }
    }

    #onceoff-total, #monthly-total{ position:relative; right:var(--total-nudge, 0px); }
    @media (max-width: 479.98px){ :root{ --total-nudge:8px; } }

    /* =========================
       Colourful summary cards (right column)
       ========================= */
    .card{ background:#fff; border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); }
    .card-h{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; padding:14px 16px; border-bottom:1px solid #f0f2f5; }
    .card-b{ padding:16px; }

    /* Blue accent (Amount to Pay Now) */
    .card-blue{ background:linear-gradient(180deg, var(--blue-50), #fff 38%); border-color:#dfe9ff; }
    .card-blue .pill{ background:#0b63e61a; color:var(--blue); border:1px solid #cfe1ff; }

    /* Teal accent (Your Monthly Invoice) */
    .card-teal{ background:linear-gradient(180deg, var(--teal-50), #fff 38%); border-color:#d4ebe8; }
    .card-teal .pill{ background:#0e5b5218; color:#0e5b52; border:1px solid #cfe7e3; }

    .pill{ display:inline-flex; align-items:center; gap:.4rem; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:600; }

    .metric{ display:flex; align-items:baseline; justify-content:space-between; gap:12px; }

    /* Reduce motion if user prefers */
    @media (prefers-reduced-motion:reduce){ *{ animation:none!important; transition:none!important; scroll-behavior:auto!important; } }
  </style>
</head>

<body class="min-h-screen flex flex-col">
  <section class="max-w-screen-xl mx-auto px-6 pt-10">
    <h1 class="text-3xl font-semibold text-gray-900">Shopping Cart</h1>
    <nav class="text-sm" aria-label="breadcrumb" style="color:#6b7280;margin-top:.5rem">
      <a href="index.html" style="color:var(--blue);text-decoration:none">Home</a>
      <span style="margin:0 .5rem;color:#9ca3af">/</span>
      <span aria-current="page">Shopping Cart</span>
    </nav>
  </section>

  <!-- Nav injection -->
  <script src="./scripts/site.js" defer></script>

  <main class="cart-grid">

    <!-- Left: tables -->
    <div class="cart-left space-y-8">
      <!-- Once-off -->
      <section>
        <h2 class="text-[1.1rem] font-semibold text-gray-900 mb-3">Once-off Charges</h2>
        <div id="onceoff-rows" class="space-y-3"></div>
        <div class="mt-3">
          <div class="table-total grid grid-cols-12 items-center p-4">
            <div class="col-span-12 md:col-span-10 label">Total (once-off)</div>
            <strong id="onceoff-total" class="col-span-12 md:col-span-2 amount tabular-nums" aria-live="polite">R 0</strong>
          </div>
        </div>
      </section>

      <!-- Monthly -->
      <section>
        <h2 class="text-[1.1rem] font-semibold text-gray-900 mb-3">Recurring Monthly Charges</h2>
        <div id="monthly-rows" class="space-y-3"></div>
        <div class="mt-3">
          <div class="table-total grid grid-cols-12 items-center p-4">
            <div class="col-span-12 md:col-span-10 label">Total (monthly)</div>
            <strong id="monthly-total" class="col-span-12 md:col-span-2 amount tabular-nums" aria-live="polite">R 0
              <span class="text-gray-500" style="font-size:12px">/month</span>
            </strong>
          </div>
        </div>
      </section>
    </div>

    <!-- Right: summary -->
    <aside class="cart-right space-y-4">

      <!-- Card 1: Pay Now (blue accent) -->
      <div class="card card-blue">
        <header class="card-h">
          <h3 class="text-lg" style="font-weight:700;color:#0b1a33">Amount to Pay Now</h3>
          <span class="pill">First month</span>
        </header>
        <div class="card-b">
          <p class="text-sm" style="color:#516072">This is your first payment, covering once-off setup and your first month’s service.</p>
          <dl class="mt-4 space-y-3 text-[0.95rem]">
            <div class="metric">
              <dt style="color:#4b5563">Once-off Charges (ex VAT)</dt>
              <dd id="subtotal-onceoff" class="tabular-nums" style="font-weight:600">R0,00</dd>
            </div>
            <div class="metric">
              <dt style="color:#4b5563">Monthly Charges (first month, ex VAT)</dt>
              <dd id="subtotal-monthly" class="tabular-nums" style="font-weight:600">R0,00</dd>
            </div>
          </dl>
          <div class="mt-4" style="border-top:1px solid #e8eefc; padding-top:12px">
            <div class="metric">
              <span class="text-sm" style="color:#4b5563">VAT @ 15%</span>
              <span id="vat-first-month" class="text-sm tabular-nums" style="font-weight:600">R0,00</span>
            </div>
            <div class="metric" style="margin-top:6px">
              <span class="text-[1.05rem]" style="font-weight:700;color:#0b1a33">Total to Pay Now</span>
              <span id="total-first-month" class="text-[1.15rem] tabular-nums" style="font-weight:700;color:#0b1a33">R0,00</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Card 2: Ongoing Invoice (teal accent) -->
      <div class="card card-teal">
        <header class="card-h">
          <h3 class="text-lg" style="font-weight:700;color:#09342f">Your Monthly Invoice</h3>
          <span class="pill">From month 2</span>
        </header>
        <div class="card-b">
          <p class="text-sm" style="color:#4c635e">From the second month onward, you’ll only pay the recurring monthly charges.</p>
          <div class="mt-4 metric text-[0.95rem]">
            <span style="color:#4b5563">Monthly Subtotal (ex VAT)</span>
            <span id="monthly-invoice-subtotal" class="tabular-nums" style="font-weight:600">R0,00</span>
          </div>
          <div class="mt-3 metric" style="border-top:1px solid #dfeceb; padding-top:12px">
            <span class="text-[1.05rem]" style="font-weight:700;color:#09342f">Monthly Total (incl VAT)</span>
            <span id="monthly-invoice-total" class="text-[1.15rem] tabular-nums" style="font-weight:700;color:#09342f">R0,00</span>
          </div>
        </div>
      </div>

      <!-- Card 3: Your Details + Actions -->
      <div class="card">
        <div class="card-b">
          <h3 class="text-lg font-bold text-gray-900">Your Details</h3>
          <form id="quick-checkout-form" class="mt-4 space-y-4" novalidate>
            <fieldset class="space-y-3">
              <label class="block">
                <span class="text-sm text-gray-700">Business name</span>
                <input
                  type="text"
                  name="businessName"
                  autocomplete="organization"
                  required
                  class="mt-1 w-full border border-gray-300 rounded-xl py-3 px-4 text-[15px] outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="e.g. Acme (Pty) Ltd"
                />
              </label>
              <label class="block">
                <span class="text-sm text-gray-700">Email address</span>
                <input
                  type="email"
                  name="email"
                  autocomplete="email"
                  required
                  class="mt-1 w-full border border-gray-300 rounded-xl py-3 px-4 text-[15px] outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="you@company.co.za"
                />
              </label>
              <label class="block">
                <span class="text-sm text-gray-700">Phone number</span>
                <input
                  type="tel"
                  name="phone"
                  inputmode="tel"
                  autocomplete="tel-national"
                  required
                  class="mt-1 w-full border border-gray-300 rounded-xl py-3 px-4 text-[15px] outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="e.g. 067 922 8256"
                />
              </label>
            </fieldset>

            <div class="space-y-3">
              <!-- Primary -->
              <button
                type="submit"
                class="w-full rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 transition"
              >
                Complete Order
              </button>

              <!-- Secondary -->
              <button
                type="button"
                id="email-quote-btn"
                class="w-full rounded-xl bg-gray-900 hover:bg-black text-white font-semibold py-3 px-4 transition"
              >
                Email Me Quote
              </button>
            </div>
          </form>
        </div>
      </div>

    </aside>
  </main>

  <footer class="mt-auto" style="background:#fff;border-top:1px solid var(--border)">
    <div class="max-w-screen-xl mx-auto px-6 py-8" style="text-align:center;font-size:14px;color:#6b7280">
      <div class="mb-2">Thank you for your order! Our team will contact you within 24 hours to confirm details and arrange delivery.</div>
      <div class="mb-2">Need help? <a href="mailto:sales@voipshop.co.za" style="color:var(--blue);text-decoration:none">Email us</a> or call <a href="tel:0679228256" style="color:var(--blue);text-decoration:none">067 922 8256</a>.</div>
      <div class="mb-2"><a href="privacy.html" class="muted">Privacy Policy</a> · <a href="terms.html" class="muted">Terms of Service</a> · <a href="legal.html" class="muted">Refund Policy</a></div>
      <div style="color:#9ca3af">© 2025 VoIP Shop. All rights reserved.</div>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="./scripts/checkout.js" defer></script>

  <!-- ✅ Monthly invoice sync (JavaScript) -->
  <script>
    (function () {
      const VAT_RATE = 0.15;

      function parseZAR(text) {
        const cleaned = String(text || "")
          .replace(/[^\d,.\-]/g, "")
          .replace(/\.(?=\d{3}\b)/g, "");
        const n = Number(cleaned.replace(",", "."));
        return Number.isFinite(n) ? n : 0;
      }

      function formatZAR(n) {
        const fixed = (Math.round(n * 100) / 100).toFixed(2);
        const [i, d] = fixed.split(".");
        const withSep = i.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        return "R " + withSep + "," + d;
      }

      function sync() {
        const subEl = document.getElementById("subtotal-monthly");
        const subOut = document.getElementById("monthly-invoice-subtotal");
        const totOut = document.getElementById("monthly-invoice-total");
        if (!subEl || !subOut || !totOut) return;

        const ex = parseZAR(subEl.textContent);
        const inc = ex * (1 + VAT_RATE);
        subOut.textContent = formatZAR(ex);
        totOut.textContent = formatZAR(inc);
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", sync);
      } else {
        sync();
      }

      const subEl = document.getElementById("subtotal-monthly");
      if (subEl) {
        new MutationObserver(sync).observe(subEl, {
          childList: true,
          characterData: true,
          subtree: true,
        });
      }

      document.addEventListener("cart:recalculated", sync);
    })();
  </script>

  <!-- ✅ Lift content-visibility on both rows and their ancestor sections -->
  <script>
    (function(){
      ["onceoff-rows","monthly-rows"].forEach(id => {
        const rows = document.getElementById(id);
        if (!rows) return;
        rows.style.contentVisibility = "visible";
        rows.style.containIntrinsicSize = "auto";
        const sec = rows.closest("section");
        if (sec) {
          sec.style.contentVisibility = "visible";
          sec.style.containIntrinsicSize = "auto";
        }
      });
    })();
  </script>

  <!-- ✅ Mobile fixes (CSS) -->
  <style>
    /* ---------- MOBILE FIXES ---------- */

    /* iOS Safari: explicitly visible on phones */
    @media (max-width: 640px){
      main, aside, section { content-visibility: visible; contain-intrinsic-size: auto; }
    }

    /* Long product names: wrap safely */
    .table-row [data-cell="name"]{
      overflow-wrap:anywhere;
      word-break:break-word;
      line-height:1.25;
    }

    /* Mobile grid with fixed total column */
    @media (max-width: 767.98px){
      .table-row{
        grid-template-columns: 1fr 104px;
        gap:8px;
        padding:10px 12px;
      }
      .table-row [data-cell="name"]  { grid-column:1/-1; }
      .table-row [data-cell="qty"]   { grid-column:1/2; justify-self:start; }
      .table-row [data-cell="total"] {
        grid-column:2/3;
        justify-self:end;
        text-align:right;
        white-space:nowrap;
        font-variant-numeric:tabular-nums;
        font-size:clamp(.92rem, 3.6vw, 1rem);
        max-width:104px;
        overflow:hidden;
        text-overflow:ellipsis;
      }
    }

    /* Ultra-small phones: slightly narrower total col */
    @media (max-width: 380px){
      .table-row{ grid-template-columns: 1fr 92px; }
      .table-row [data-cell="total"]{ max-width:92px; font-size:.9rem; }
    }

    /* Qty control: compact on phones */
    @media (max-width: 480px){
      :root{ --qty-pill-number-nudge:0; }
      .qty-pill{ height:26px; border-radius:9px; transform:none; }
      .qty-btn{ width:26px; font-size:13px; }
      .qty-value{ min-width:26px; font-size:12px; }
      .qty-plain{ height:26px; min-width:30px; padding:0 6px; font-size:12px; }
    }

    /* Totals rows: fixed right column width on mobile */
    @media (max-width: 640px){
      .table-total{ border-radius:12px; padding:10px 12px !important; }
      .table-total .label{ font-size:.9rem; }
      .table-total .amount{
        font-size:clamp(1rem, 4vw, 1.05rem);
        white-space:nowrap;
      }
      .table-total.grid{
        grid-template-columns: 1fr 130px;
        column-gap:10px;
      }
    }

    /* Summary cards */
    @media (max-width: 1024px){
      .card-h{ padding:12px 14px; }
      .card-b{ padding:14px; }
      .pill{ font-size:11.5px; padding:3px 9px; }
    }

    /* Footer breathing room so WhatsApp floater doesn't overlap */
    @media (max-width: 640px){
      footer{ padding-bottom:64px; }
      .card:last-of-type{ margin-bottom:8px; }
    }

    /* Breadcrumb + H1 sizing */
    @media (max-width: 480px){
      h1.text-3xl{ font-size:1.5rem; }
      nav[aria-label="breadcrumb"]{ font-size:12px; }
    }

    /* Fallback if Tailwind grid helpers aren’t present */
    @media (max-width: 1023.98px){
      .lg\:col-span-8, .lg\:col-span-4 { grid-column: auto / span 12; }
    }
  </style>

  <!-- (Optional safety) Keep these overrides; harmless if globals are removed -->
  <style>
    /* Turn off content-visibility for dynamic billing tables (explicit) */
    #monthly-rows,
    #monthly-rows ~ .mt-3,
    #onceoff-rows,
    #onceoff-rows ~ .mt-3 {
      content-visibility: visible !important;
      contain-intrinsic-size: auto !important;
    }
  </style>

  <!-- WhatsApp floater (kept) -->
  <a href="https://wa.me/27679228256?text=Hi%20VoIP%20Shop%2C%20I%20need%20help" target="_blank" rel="noopener"
     aria-label="Chat to VoIP Shop on WhatsApp"
     style="position:fixed;z-index:60;right:16px;bottom:16px;background:#25D366;color:#fff;
            border-radius:999px;padding:8px 12px;display:flex;gap:8px;align-items:center;
            box-shadow:0 10px 24px rgba(0,0,0,.16)">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18"
         fill="currentColor" aria-hidden="true">
      <path d="M20.52 3.48A11.91 11.91 0 0 0 12 0C5.37 0 0 5.37 0 12c0 2.12.55 4.16 1.59 5.97L0 24
               l6.2-1.58A11.94 11.94 0 0 0 12 24c6.63 0 12-5.37 12-12
               0-3.19-1.24-6.2-3.48-8.52zM12 21.5c-1.9 0-3.73-.5-5.34-1.45l-.38-.22-3.68.94.98-3.59
               -.25-.37A9.46 9.46 0 0 1 2.5 12C2.5 6.76 6.76 2.5 12 2.5c2.52 0 4.9.98
               6.71 2.79A9.45 9.45 0 0 1 21.5 12c0 5.24-4.26 9.5-9.5 9.5zm5.37-7.13
               c-.3-.15-1.77-.87-2.05-.97-.27-.1-.47-.15-.67.15s-.77.97-.94
               1.17c-.17.2-.35.22-.65.07-.3-.15-1.26-.46-2.4-1.46-.89-.79-1.5-1.77-1.67-2.07
               -.17-.3-.02-.46.13-.61.13-.13.3-.35.45-.52.15-.17.2-.3.3-.5.1-.2.05-.37
               -.02-.52-.07-.15-.67-1.62-.91-2.21-.24-.59-.48-.5-.67-.51h-.57
               c-.2 0-.52 .07-.79 .37s-1.04 1.02-1.04 2.5
               1.07 2.9 1.22 3.1c.15 .2 2.1 3.2 5.1 4.5 .71 .3 1.27 .48 1.7
               .62 .71 .23 1.35 .2 1.86 .12 .57 -.08 1.77 -.72
               2.02 -1.42 .25 -.7 .25 -1.3 .17 -1.42 -.08 -.12 -.27 -.2 -.57 -.35z"/>
    </svg>
    <span style="font-size:14px;font-weight:600">Need help?</span>
  </a>

  <!-- ✅ Checkout wiring (moved to end, DOM-safe, guarded) -->
  <script>
    (function () {
      const SITE_KEY = '6LcI2rUrAAAAADaW9lGy3WZfBS-KzmnhWpOlcSVw'; // reCAPTCHA v3

      // Parse "R 1.499,00" / "R 1499.00" safely
      const money = (t) => {
        const s = String(t || '')
          .replace(/[^\d,.\-]/g, '')
          .replace(/\.(?=\d{3}\b)/g, ''); // drop thousand points
        const n = Number(s.replace(',', '.'));
        return Number.isFinite(n) ? n : 0;
      };

      // Read ex-VAT subtotals first (preferred), fall back to table totals
      function readTotals() {
        let onceOff = money(document.getElementById('subtotal-onceoff')?.textContent);
        let monthly = money(document.getElementById('subtotal-monthly')?.textContent);
        if (!onceOff) onceOff = money(document.getElementById('onceoff-total')?.textContent);
        if (!monthly) monthly = money(document.getElementById('monthly-total')?.textContent);
        return { onceOff, monthly };
      }

      // Persist for the Order Received page (used by your conversion code)
      function saveMeta({ email, orderNumber, monthly, onceOff }) {
        sessionStorage.setItem('checkoutMeta', JSON.stringify({
          email,
          orderNumber,
          subtotals: { monthly, onceOff }
        }));
      }
      function saveDownloads(maybe) {
        if (!maybe) return;
        sessionStorage.setItem('orderDownloads', JSON.stringify(maybe));
      }

      async function withCaptcha(action) {
        if (!window.grecaptcha?.execute) throw new Error('reCAPTCHA not loaded');
        await new Promise(res => grecaptcha.ready(res));
        return await grecaptcha.execute(SITE_KEY, { action });
      }

      async function postJSON(url, data) {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!res.ok) throw new Error('Request failed ' + res.status);
        return await res.json().catch(() => ({}));
      }

      function init() {
        if (window.__checkoutWired) return; // prevent double-binding
        window.__checkoutWired = true;

        const form = document.getElementById('quick-checkout-form');
        const emailQuoteBtn = document.getElementById('email-quote-btn');

        // Complete Order
        if (form) {
          form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(form);
            const email = (fd.get('email') || '').toString().trim();
            const business = (fd.get('businessName') || '').toString().trim();
            const phone = (fd.get('phone') || '').toString().trim();
            const { onceOff, monthly } = readTotals();

            const btn = form.querySelector('button[type="submit"]');
            btn.disabled = true;

            try {
              const token = await withCaptcha('complete_order');
              const payload = { email, business, phone, totals: { onceOff, monthly }, token };

              // 🔧 TODO: point at your real backend
              const resp = await postJSON('/api/checkout/complete', payload);

              const orderNumber = resp.orderNumber || ('VS-' + Date.now());
              saveMeta({ email, orderNumber, monthly, onceOff });
              saveDownloads({ invoiceUrl: resp.invoiceUrl, slaUrl: resp.slaUrl, portingUrl: resp.portingUrl });

              // (Optional) remarketing signal — safe if not configured
              if (window.gtag) gtag('event', 'begin_checkout', { value: onceOff + monthly, currency: 'ZAR' });

              const q = new URLSearchParams({ order: orderNumber, email }).toString();
              location.href = 'post-checkout.html?' + q;
            } catch (err) {
              console.error('[checkout] submit failed', err);
              alert('Sorry — we couldn’t complete your order right now. Please try again or use “Email Me Quote”.');
            } finally {
              btn.disabled = false;
            }
          });
        }

// Email Me Quote  ➜ thank-you.html
if (emailQuoteBtn) {
  emailQuoteBtn.addEventListener('click', async () => {
    const form = document.getElementById('quick-checkout-form');
    const fd = new FormData(form);
    const email    = (fd.get('email') || '').toString().trim();
    const business = (fd.get('businessName') || '').toString().trim();
    const phone    = (fd.get('phone') || '').toString().trim();
    const { onceOff, monthly } = readTotals();

    if (!email) { alert('Please enter your email so we can send the quote.'); return; }

    emailQuoteBtn.disabled = true;
    try {
      const token   = await withCaptcha('email_quote');
      const payload = { email, business, phone, totals: { onceOff, monthly }, token };

      // 🔧 point to your real endpoint
      const resp = await postJSON('/api/checkout/email-quote', payload);

      const orderNumber = resp.orderNumber || ('VS-QUOTE-' + Date.now());
      saveMeta({ email, orderNumber, monthly, onceOff });
      saveDownloads({ invoiceUrl: resp.invoiceUrl, slaUrl: resp.slaUrl, portingUrl: resp.portingUrl });

      if (window.gtag) gtag('event', 'generate_lead', { value: onceOff + monthly, currency: 'ZAR' });

      // ✅ redirect to thank-you.html
      const qs = new URLSearchParams({ order: orderNumber, email, intent: 'quote' }).toString();
      window.location.assign('thank-you.html?' + qs);
    } catch (err) {
      console.error('[checkout] quote failed', err);
      // Still send them to thank-you so UX & tracking aren’t blocked
      const qs = new URLSearchParams({ email, intent: 'quote', offline: '1' }).toString();
      window.location.assign('thank-you.html?' + qs);
    } finally {
      emailQuoteBtn.disabled = false;
    }
  });
}

      }

      // Ensure DOM is ready before wiring
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>

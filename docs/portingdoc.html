<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Number Porting — Letter of Authority</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @media print { .no-print { display:none !important; } }
    .sig-canvas { touch-action: none; }
  </style>
</head>
<body class="bg-[#F5F5F7] text-gray-900">
  <main class="mx-auto max-w-3xl px-4 sm:px-6 lg:px-8 py-8 sm:py-12">
    <!-- Header -->
    <header class="flex items-start gap-4">
      <img src="Assets/Group 1642logo (1).png" alt="VoIP Shop" class="h-10 w-auto object-contain" onerror="this.style.display='none'">
      <div class="text-sm text-gray-600 leading-5">
        <div class="font-medium text-gray-900">VoIP Shop</div>
        <div>Umojanet (Pty) Ltd t/a Voipshop</div>
        <div>Reg: 2025/406791/07</div>
        <div>+27 68 351 0074 • sales@voipshop.co.za</div>
      </div>
    </header>

    <section class="mt-6 rounded-2xl border border-gray-200 bg-white p-6 shadow-[0_10px_30px_rgba(0,0,0,0.06)]">
      <h1 class="text-2xl font-semibold tracking-tight">Letter of Authority – Number Porting</h1>
      <p class="mt-1 text-sm text-gray-600">Please complete and sign to authorise VoIP Shop to port your numbers from your current provider.</p>

      <!-- Client / Account holder -->
      <div class="mt-6 grid gap-4 sm:grid-cols-2">
        <div>
          <label class="block text-sm text-gray-600">Account Holder (as on bill) *</label>
          <input id="accHolder" required class="mt-1 w-full rounded-xl border-gray-300 bg-white px-3 py-2 text-sm" />
        </div>
        <div>
          <label class="block text-sm text-gray-600">Company Reg / ID No.</label>
          <input id="regNo" class="mt-1 w-full rounded-xl border-gray-300 bg-white px-3 py-2 text-sm" />
        </div>
        <div>
          <label class="block text-sm text-gray-600">Contact Person *</label>
          <input id="contactName" required class="mt-1 w-full rounded-xl border-gray-300 bg-white px-3 py-2 text-sm" />
        </div>
        <div>
          <label class="block text-sm text-gray-600">Contact Email *</label>
          <input id="contactEmail" type="email" required class="mt-1 w-full rounded-xl border-gray-300 bg-white px-3 py-2 text-sm" />
        </div>
        <div>
          <label class="block text-sm text-gray-600">Contact Number *</label>
          <input id="contactPhone" required class="mt-1 w-full rounded-xl border-gray-300 bg-white px-3 py-2 text-sm" />
        </div>
        <div class="sm:col-span-2">
          <label class="block text-sm text-gray-600">Service / Installation Address</label>
          <input id="serviceAddress" class="mt-1 w-full rounded-xl border-gray-300 bg-white px-3 py-2 text-sm" />
        </div>
      </div>

      <!-- Donor provider details -->
      <div class="mt-6 grid gap-4 sm:grid-cols-2">
        <div>
          <label class="block text-sm text-gray-600">Current (Donor) Provider *</label>
          <input id="donorProvider" required class="mt-1 w-full rounded-xl border-gray-300 bg-white px-3 py-2 text-sm" placeholder="e.g., Telkom, Vodacom, etc." />
        </div>
        <div>
          <label class="block text-sm text-gray-600">Donor Account Number *</label>
          <input id="donorAccount" required class="mt-1 w-full rounded-xl border-gray-300 bg-white px-3 py-2 text-sm" />
        </div>
      </div>

      <!-- Latest bill upload -->
      <div class="mt-6">
        <label class="block text-sm text-gray-600">Upload latest telecoms account (PDF/JPG/PNG, max 10MB) *</label>
        <input id="billFile" type="file" accept=".pdf,.jpg,.jpeg,.png" required class="mt-1 block w-full text-sm text-gray-700 file:mr-4 file:rounded-full file:border-0 file:bg-[#E7F0FF] file:px-4 file:py-2 file:text-sm file:font-semibold file:text-[#0B63E6] hover:file:bg-[#d9e8ff]" />
        <p class="mt-1 text-xs text-gray-500">Ensure the account name and number match the details above.</p>
      </div>

      <!-- Numbers to port -->
      <div class="mt-6">
        <div class="flex items-center justify-between">
          <label class="block text-sm text-gray-600">Numbers to Port *</label>
          <button id="btnAddNumber" type="button" class="inline-flex items-center rounded-full border border-gray-300 bg-white px-3 py-1.5 text-xs font-semibold hover:bg-gray-50">Add number</button>
        </div>
        <div id="numbersList" class="mt-2 space-y-2">
          <!-- rows injected here -->
        </div>
        <p class="mt-1 text-xs text-gray-500">Enter one number per row. Include area code (e.g., 011…).</p>
      </div>

      <!-- Preferences -->
      <div class="mt-6 grid gap-4 sm:grid-cols-2">
        <div>
          <label class="block text-sm text-gray-600">Preferred Port Date (optional)</label>
          <input id="portDate" type="date" class="mt-1 w-full rounded-xl border-gray-300 bg-white px-3 py-2 text-sm" />
        </div>
        <div>
          <label class="block text-sm text-gray-600">Time Window (optional)</label>
          <select id="portTime" class="mt-1 w-full rounded-xl border-gray-300 bg-white px-3 py-2 text-sm">
            <option value="">No preference</option>
            <option>08:00–10:00</option>
            <option>10:00–12:00</option>
            <option>12:00–14:00</option>
            <option>14:00–16:00</option>
          </select>
        </div>
      </div>

      <!-- Declaration -->
      <div class="mt-6 rounded-xl bg-[#F9FAFB] border border-gray-200 p-4 text-sm text-gray-700">
        <p>
          I, the undersigned, hereby authorise VoIP Shop (Umojanet (Pty) Ltd t/a Darkwire) to port the telephone number(s) listed above from my current provider to VoIP Shop. I warrant that I am the account holder or an authorised representative. I acknowledge that porting timing is controlled by the donor network and that a brief service interruption may occur during the porting window.
        </p>
      </div>

      <!-- Signature -->
      <div class="mt-6 grid gap-6 sm:grid-cols-2">
        <div>
          <label class="block text-sm text-gray-600 mb-2">Signature *</label>
          <div class="rounded-xl border border-gray-300 bg-white p-2">
            <canvas id="sigpad" class="sig-canvas w-full" height="160"></canvas>
          </div>
          <div class="mt-2 flex items-center gap-2">
            <button id="clearSig" type="button" class="inline-flex items-center rounded-full border border-gray-300 bg-white px-3 py-1.5 text-sm font-semibold hover:bg-gray-50">Clear</button>
            <span class="text-xs text-gray-500">Use mouse or finger to sign.</span>
          </div>
        </div>
        <div class="grid gap-4 content-start">
          <div>
            <label class="block text-sm text-gray-600">Name of Signatory *</label>
            <input id="signName" required class="mt-1 w-full rounded-xl border-gray-300 bg-white px-3 py-2 text-sm" />
          </div>
          <div>
            <label class="block text-sm text-gray-600">Position</label>
            <input id="signTitle" class="mt-1 w-full rounded-xl border-gray-300 bg-white px-3 py-2 text-sm" />
          </div>
          <div>
            <label class="block text-sm text-gray-600">Date *</label>
            <input id="signDate" type="date" required class="mt-1 w-full rounded-xl border-gray-300 bg-white px-3 py-2 text-sm" />
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="mt-6 flex flex-wrap items-center gap-3">
        <button id="btnSend" class="inline-flex items-center rounded-full bg-[#0071E3] px-5 py-2.5 text-sm font-semibold text-white hover:bg-[#0066CC]">Sign & Send</button>
        <button id="btnDownload" class="inline-flex items-center rounded-full border border-gray-300 bg-white px-5 py-2.5 text-sm font-semibold hover:bg-gray-50">Download PDF</button>
        <span id="statusMsg" class="text-sm text-gray-600"></span>
      </div>
    </section>

    <footer class="mt-6 text-xs text-gray-500">
      <p>Support: WhatsApp +27 71 005 7691 • Email sales@voipshop.co.za</p>
    </footer>
  </main>

  <!-- Signature Pad & jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script>
    // ===== Replace with your backend endpoints =====
    const SEND_ENDPOINT = '/api/porting/loa'; // accepts multipart/form-data: fields + pdf + billFile

    // Prefill today's date
    document.getElementById('signDate').value = new Date().toISOString().slice(0,10);

    // Numbers list helper
    const numbersList = document.getElementById('numbersList');
    function addNumberRow(value='') {
      const row = document.createElement('div');
      row.className = 'flex items-center gap-2';
      row.innerHTML = `
        <input type="tel" pattern="[0-9+\\- ]+" placeholder="e.g., 011 123 4567" class="flex-1 rounded-xl border-gray-300 bg-white px-3 py-2 text-sm" value="${value}" required>
        <button type="button" class="inline-flex items-center rounded-full border border-gray-300 bg-white px-3 py-1.5 text-xs font-semibold hover:bg-gray-50">Remove</button>
      `;
      row.querySelector('button').addEventListener('click', () => row.remove());
      numbersList.appendChild(row);
    }
    document.getElementById('btnAddNumber').addEventListener('click', () => addNumberRow());
    // start with one row
    addNumberRow();

    // Signature pad
    const canvas = document.getElementById('sigpad');
    const sigPad = new SignaturePad(canvas, { backgroundColor: 'rgba(255,255,255,0)', penColor: '#0B63E6' });
    function resizeCanvas() {
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * ratio;
      canvas.height = 160 * ratio;
      canvas.getContext('2d').scale(ratio, ratio);
      sigPad.clear();
    }
    window.addEventListener('resize', resizeCanvas);
    setTimeout(resizeCanvas, 0);
    document.getElementById('clearSig').addEventListener('click', () => sigPad.clear());

    // Validation
    function validForm() {
      const needIds = ['accHolder','contactName','contactEmail','contactPhone','donorProvider','donorAccount','signName','signDate'];
      for (const id of needIds) { const el = document.getElementById(id); if (!el || !el.value.trim()) return false; }
      if (!document.getElementById('billFile').files[0]) return false;
      // at least one number
      if (!numbersList.querySelector('input')) return false;
      if (sigPad.isEmpty()) return false;
      return true;
    }

    async function buildPdf() {
      const { jsPDF } = window.jspdf; const doc = new jsPDF({ unit:'pt', format:'a4' });
      const m = 48; let y = m; const line = (t, s=11, b=false) => { doc.setFont('helvetica', b?'bold':'normal'); doc.setFontSize(s); doc.text(t, m, y); y += 18; };
      doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.text('Letter of Authority – Number Porting', m, y); y += 22;
      doc.setFont('helvetica',''); doc.setFontSize(10);
      line(`Account Holder: ${document.getElementById('accHolder').value}`);
      const reg = document.getElementById('regNo').value; if (reg) line(`Reg/ID: ${reg}`);
      line(`Contact: ${document.getElementById('contactName').value} • ${document.getElementById('contactEmail').value} • ${document.getElementById('contactPhone').value}`);
      const addr = document.getElementById('serviceAddress').value; if (addr) line(`Service Address: ${addr}`);
      y += 6; line('Donor Provider Details', 11, true);
      line(`Provider: ${document.getElementById('donorProvider').value}`);
      line(`Account No: ${document.getElementById('donorAccount').value}`);
      y += 6; line('Numbers to Port', 11, true);
      const nums = Array.from(numbersList.querySelectorAll('input')).map(i=>i.value.trim()).filter(Boolean);
      for (const n of nums) line('• ' + n);
      y += 6; line('Preferences', 11, true);
      const date = document.getElementById('portDate').value; const time = document.getElementById('portTime').value;
      line(`Preferred Date: ${date||'—'}  Time: ${time||'—'}`);
      y += 6; line('Declaration', 11, true);
      const para = 'I authorise VoIP Shop (Umojanet (Pty) Ltd t/a Darkwire) to port the above numbers from my current provider. I confirm I am the account holder or authorised representative. I acknowledge that porting windows are controlled by the donor network and a brief outage may occur during cutover.';
      const wrapped = doc.splitTextToSize(para, 500); for (const w of wrapped) line(w, 10);
      y += 8; line('Client Acceptance', 11, true);
      line(`Signed by: ${document.getElementById('signName').value}`);
      const title = document.getElementById('signTitle').value; if (title) line(`Position: ${title}`);
      line(`Date: ${document.getElementById('signDate').value}`);
      const sigData = sigPad.toDataURL('image/png'); doc.addImage(sigData, 'PNG', m, y, 180, 60);
      return doc;
    }

    document.getElementById('btnDownload').addEventListener('click', async () => {
      if (!validForm()) { document.getElementById('statusMsg').textContent = 'Please complete all required fields and sign.'; return; }
      const doc = await buildPdf();
      const name = (document.getElementById('accHolder').value || 'Client').replace(/\s+/g,'_');
      const date = (document.getElementById('signDate').value || '').replaceAll('-','');
      doc.save(`Porting_LOA_${name}_${date}.pdf`);
      document.getElementById('statusMsg').textContent = 'PDF downloaded.';
    });

    document.getElementById('btnSend').addEventListener('click', async () => {
      if (!validForm()) { document.getElementById('statusMsg').textContent = 'Please complete all required fields and sign.'; return; }
      document.getElementById('statusMsg').textContent = 'Sending…';
      try {
        const pdf = await buildPdf();
        const blob = pdf.output('blob');
        const form = new FormData();
        form.append('accHolder', document.getElementById('accHolder').value);
        form.append('regNo', document.getElementById('regNo').value);
        form.append('contactName', document.getElementById('contactName').value);
        form.append('contactEmail', document.getElementById('contactEmail').value);
        form.append('contactPhone', document.getElementById('contactPhone').value);
        form.append('serviceAddress', document.getElementById('serviceAddress').value);
        form.append('donorProvider', document.getElementById('donorProvider').value);
        form.append('donorAccount', document.getElementById('donorAccount').value);
        const nums = Array.from(numbersList.querySelectorAll('input')).map(i=>i.value.trim()).filter(Boolean);
        form.append('numbers', JSON.stringify(nums));
        const bill = document.getElementById('billFile').files[0];
        form.append('billFile', bill, bill.name);
        form.append('signName', document.getElementById('signName').value);
        form.append('signTitle', document.getElementById('signTitle').value);
        form.append('signDate', document.getElementById('signDate').value);
        form.append('signaturePng', sigPad.toDataURL('image/png'));
        form.append('loaPdf', blob, 'porting-loa.pdf');
        const res = await fetch(SEND_ENDPOINT, { method: 'POST', body: form });
        if (!res.ok) throw new Error('Failed');
        document.getElementById('statusMsg').textContent = 'Submitted! We\'ll confirm receipt via email.';
      } catch (e) {
        document.getElementById('statusMsg').textContent = 'Could not send automatically. Please use Download PDF and email it to admin@darkwire.co.za';
      }
    });
  </script>
</body>
</html>
